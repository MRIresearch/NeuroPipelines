Bootstrap: docker
From: ubuntu:xenial

%help
Singularity container with: 
    latest Freesurfer development version (/opt/freesurfer-dev)
    Stable freesurver 6.0 with applied patch (/opt/freesurfer) see notes: https://surfer.nmr.mgh.harvard.edu/fswiki/BrainVolStatsFixed
    The freesurfer version 5.3.0 used for HCP processing (/opt/freesurfer-HCP)

Please refer to https://github.com/MRIresearch/NeuroPipelines/blob/master/containers/nklab-fsl/README.md for more information about this container.


%setup

%files
./src/license.txt /
./src/startup.sh /
./src/startup.m /
./src/readme /
./src/version /

%environment
export LC_ALL=en_US.UTF-8
export FREESURFER_HOME=/opt/freesurfer
export FS_LICENSE=$FREESURFER_HOME/license.txt
export PATH=$FREESURFER_HOME/bin:$PATH

export LD_LIBRARY_PATH=/.singularity.d/libs:/usr/lib:/opt/freesurfer/mni/lib:$LD_LIBRARY_PATH

export PATH=/opt/bin:$PATH


%runscript
cd /opt/data
exec /opt/bin/startup.sh "$@"

%test

%post
mkdir -p /uaopt /extra /xdisk /rsgrps /opt/data /opt/bin /opt/work /opt/input /opt/output /cm/shared /cm/local /opt/config

export DEBIAN_FRONTEND=noninteractive
export TZ=America/Phoenix
ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone


apt-get update

apt-get install -y \
locales 

echo "LC_ALL=en_US.UTF-8" >> /etc/environment
echo "en_US.UTF-8 UTF-8" >> /etc/locale.gen
echo "LANG=en_US.UTF-8" > /etc/locale.conf
locale-gen en_US.UTF-8
export LC_ALL=en_US.UTF-8

apt-get install -y \
	nano \
	apt-utils \
	wget \
	curl \
        dc \
	lsb-core 


#libraries for freesurfer-dev
apt-get install -y  tcsh \
        libglu1-mesa-dev \
        gfortran \
        libxmu6

#install Qt 5.9.1 for freesurfer-dev
apt install -y software-properties-common
add-apt-repository universe
printf '\n' | add-apt-repository ppa:beineri/opt-qt591-xenial
apt-get update
apt install -y qt-latest 
#set up environmental variables
export PATH=/opt/qt591/bin:$PATH
export LD_LIBRARY_PATH=/opt/qt591/lib:$LD_LIBRARY_PATH
export QT_SELECT=opt-qt591
export QTTOOLDIR=/opt/qt51/bin
export QTLIBDIR=/opt/qt591/lib


#install libraries to resolve issue with  QGtkStyle could not resolve GTK
apt-get install -y libgnomeui-0
apt-get install -y libcanberra-gtk0

# install freesurfer dev
cd /opt
export FREESURFER_HOME=/opt/freesurfer-dev
wget ftp://surfer.nmr.mgh.harvard.edu/pub/dist/freesurfer/dev/freesurfer-linux-centos6_x86_64-dev.tar.gz
tar xz -f freesurfer-linux-centos6_x86_64-dev.tar.gz
mv freesurfer freesurfer-dev
rm /opt/freesurfer-linux-centos6_x86_64-dev.tar.gz
cd $FREESURFER_HOME
curl "https://surfer.nmr.mgh.harvard.edu/fswiki/MatlabRuntime?action=AttachFile&do=get&target=runtime2014bLinux.tar.gz" -o "runtime.tar.gz"
tar xvf runtime.tar.gz
rm $FREESURFER_HOME/runtime.tar.gz


#libraries for freesurfer-HCP
apt-get install -y libfreetype6 \
libxrender1 \
libfontconfig1 \
libxss1 \
libxft2 \
libjpeg62 

cd /opt
wget https://www.dropbox.com/s/s50sdblfvpdr6ut/freesurfer-Linux-centos6_x86_64-stable-pub-v5.3.0-HCP.tar.gz
tar xz -f freesurfer-Linux-centos6_x86_64-stable-pub-v5.3.0-HCP.tar.gz
mv freesurfer freesurfer-HCP
rm /opt/freesurfer-Linux-centos6_x86_64-stable-pub-v5.3.0-HCP.tar.gz

# install freesurfer stable
cd /opt
export FREESURFER_HOME=/opt/freesurfer
wget https://surfer.nmr.mgh.harvard.edu/pub/dist/freesurfer/6.0.0/freesurfer-Linux-centos6_x86_64-stable-pub-v6.0.0.tar.gz
tar xz -f freesurfer-Linux-centos6_x86_64-stable-pub-v6.0.0.tar.gz
cd /usr/lib/x86_64-linux-gnu
ln -s libtiff.so.4 libtiff.so.3
rm /opt/freesurfer-Linux-centos6_x86_64-stable-pub-v6.0.0.tar.gz

# apply freesurfer patch
tempdir=/tmp/freesurfer-patch-6.0.0
mkdir -p $tempdir
cd $tempdir

PATCHLOC=surfer.nmr.mgh.harvard.edu/pub/dist/freesurfer/6.0.0-patch
wget --recursive ftp://$PATCHLOC/
chmod -R +x ./$PATCHLOC

FREESURFER_BIN=/opt/freesurfer/bin
mv $FREESURFER_BIN/make_average_surface $FREESURFER_BIN/old_make_average_surface  
cp ./$PATCHLOC/make_average_surface $FREESURFER_BIN/make_average_surface

mv $FREESURFER_BIN/mri_glmfit-sim $FREESURFER_BIN/old_mri_glmfit-sim 
cp ./$PATCHLOC/mri_glmfit-sim $FREESURFER_BIN/mri_glmfit-sim

mv $FREESURFER_BIN/mris_anatomical_stats $FREESURFER_BIN/old_mris_anatomical_stats
cp ./$PATCHLOC/mris_anatomical_stats.linux $FREESURFER_BIN/mris_anatomical_stats

mv $FREESURFER_BIN/mri_segstats $FREESURFER_BIN/old_mri_segstats
cp ./$PATCHLOC/mri_segstats.linux $FREESURFER_BIN/mri_segstats

mv $FREESURFER_BIN/recon-all $FREESURFER_BIN/old_recon-all
cp ./$PATCHLOC/recon-all $FREESURFER_BIN/recon-all

rm ./$PATCHLOC/PALM/README
mv $FREESURFER_BIN/mri_surfcluster $FREESURFER_BIN/old_mri_surfcluster
mv $FREESURFER_BIN/mri_volcluster $FREESURFER_BIN/old_mri_volcluster
cp ./$PATCHLOC/PALM/* $FREESURFER_BIN

rm ./$PATCHLOC/hcp/README
cp ./$PATCHLOC/hcp/* $FREESURFER_BIN

rm -R $tempdir


mv /license.txt /opt/freesurfer/license.txt
mv /startup.sh /opt/bin
mv /readme /opt/bin
mv /version /opt/bin
mv /startup.m /opt/bin
cp /opt/freesurfer/license.txt /opt/freesurfer-dev/
cp /opt/freesurfer/license.txt /opt/freesurfer-HCP/
